#!/bin/sh

# Abort if any command returns an error
set -e

# Script to install required external packages

# Set location of ruby to use
RUBY=`which ruby`
for arg in $@; do
  case $arg in
    --with-ruby=*) RUBY=`echo $arg | cut -f 2 -d "="`/bin/ruby;;
    -h|--help) echo
               echo "Run this script to install the Workflow Manager"
               echo
               echo "INSTALL [--with-ruby=/path/to/ruby]"
               echo
               exit;;
    *)
  esac 
done

# Make sure ruby exists
if [ -x $RUBY ]; then
  echo "Installing using $RUBY"
else
  echo "Installation failed.  $RUBY does not exist"
  exit 1
fi

# Make sure ruby is at least 1.8.7 or higher
good_ruby=`$RUBY -e "puts RUBY_VERSION >= '1.8.7'"`
if [ "$good_ruby" == "false" ]; then
  echo "Ruby 1.8.7 or higher is required"
  exit 1
fi

# Replace ruby shebangs with path to ruby
for file in `ls sbin`; do

  # Skip files that are links
  if [ -L sbin/$file ]; then
    continue
  fi

  # Replace first line with correct shebang
  sed "1c\#!${RUBY}" sbin/$file > sbin/$file.new
  mv sbin/$file.new sbin/$file

  # Make sure the new file is executable
  chmod ugo+x sbin/$file

done

# Package versions
LIBXML_VERSION="2.3.3"
SYSTEMTIMER_VERSION="1.2.3"
SQLITE3_VERSION="autoconf-3070701"
SQLITE3_RUBY_VERSION="1.3.1"

# Set location of WFM
WFM_DIR=`pwd`

# Set location where tarfiles for packages are kept
TAR_DIR=${WFM_DIR}/tarfiles

# Set location where packages are built
BUILD_DIR=${WFM_DIR}/build

# Set the location where libraries are installed
LIB_DIR=${WFM_DIR}/lib

# Create the build directory
mkdir -p ${BUILD_DIR}

# Install libxml-ruby
echo "==========================================="
echo "= INSTALLING libxml-ruby                  ="
echo "==========================================="
cd ${BUILD_DIR}
tar -xzvf ${TAR_DIR}/libxml-ruby-${LIBXML_VERSION}.tar.gz
cd libxml-ruby-${LIBXML_VERSION}/ext/libxml
${RUBY} extconf.rb
make clean
make
rm -rf ${LIB_DIR}/libxml-ruby
mkdir ${LIB_DIR}/libxml-ruby
cp -r ${BUILD_DIR}/libxml-ruby-${LIBXML_VERSION}/lib/* ${LIB_DIR}/libxml-ruby
cp libxml_ruby.so ${LIB_DIR}/libxml-ruby

# Install SystemTimer
echo "==========================================="
echo "= INSTALLING SystemTimer                  ="
echo "==========================================="
cd ${BUILD_DIR}
tar -xzvf ${TAR_DIR}/SystemTimer-${SYSTEMTIMER_VERSION}.tar.gz
cd SystemTimer-${SYSTEMTIMER_VERSION}/ext/system_timer
${RUBY} extconf.rb
make clean
make
rm -rf ${LIB_DIR}/SystemTimer
mkdir ${LIB_DIR}/SystemTimer
cp -r ${BUILD_DIR}/SystemTimer-${SYSTEMTIMER_VERSION}/lib/* ${LIB_DIR}/SystemTimer
cp system_timer_native.so ${LIB_DIR}/SystemTimer

# Install sqlite3
echo "==========================================="
echo "= INSTALLING sqlite3                      ="
echo "==========================================="
cd ${BUILD_DIR}
tar -xzvf ${TAR_DIR}/sqlite-${SQLITE3_VERSION}.tar.gz
cd sqlite-${SQLITE3_VERSION}
export CFLAGS="-Os -DSQLITE_ENABLE_COLUMN_METADATA -DSQLITE_THREADSAFE=1"
./configure --prefix=${LIB_DIR}/sqlite3
make clean
make
rm -rf ${LIB_DIR}/sqlite3
make install
unset CFLAGS

# Install sqlite3-ruby
echo "==========================================="
echo "= INSTALLING sqlite3-ruby                 ="
echo "==========================================="
cd ${BUILD_DIR}
tar -xzvf ${TAR_DIR}/sqlite3-ruby-${SQLITE3_RUBY_VERSION}.tar.gz
cd sqlite3-ruby-${SQLITE3_RUBY_VERSION}/ext/sqlite3
export LD_RUN_PATH=${LIB_DIR}/sqlite3/lib
${RUBY} extconf.rb -- --with-sqlite3-dir=${LIB_DIR}/sqlite3
make clean
make
rm -rf ${LIB_DIR}/sqlite3-ruby
mkdir ${LIB_DIR}/sqlite3-ruby
cp -r ${BUILD_DIR}/sqlite3-ruby-${SQLITE3_RUBY_VERSION}/lib/* ${LIB_DIR}/sqlite3-ruby
cp sqlite3_native.so ${LIB_DIR}/sqlite3-ruby/sqlite3
unset LDFLAGS

